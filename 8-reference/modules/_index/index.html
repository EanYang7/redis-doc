
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction to writing Redis modules
">
      
      
        <meta name="author" content="Ean Yang">
      
      
        <link rel="canonical" href="https://eanyang7.github.io/redis-doc/8-reference/modules/_index/">
      
      
        <link rel="prev" href="../../internals/rdd/">
      
      
        <link rel="next" href="../modules-api-ref/">
      
      
      <link rel="icon" href="../../../assets/favicon.jpg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.12">
    
    
      
        <title>Redis modules API - redis 文档</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.fad675c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="deep-purple">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#loading-modules" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="redis 文档" class="md-header__button md-logo" aria-label="redis 文档" data-md-component="logo">
      
  <img src="../../../assets/logo.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            redis 文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Redis modules API
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="deep-purple"  aria-label="切换为暗黑模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换为暗黑模式" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="red"  aria-label="切换为浅色模式"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="切换为浅色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/EanYang7/redis-doc" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    github仓库
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="redis 文档" class="md-nav__button md-logo" aria-label="redis 文档" data-md-component="logo">
      
  <img src="../../../assets/logo.jpg" alt="logo">

    </a>
    redis 文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/EanYang7/redis-doc" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    github仓库
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../0-about/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    0 about
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../1-get-started/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    1 get started
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../2-install/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    2 install
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../3-connect/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    3 connect
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../4-data-types/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    4 data types
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../5-interact/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    5 interact
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../6-manual/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    6 manual
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../7-management/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    7 management
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    8 reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            8 reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../arm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ARM support
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../clients/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis client handling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis cluster specification
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../command-arguments/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis command arguments
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../command-tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis command tips
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../gopher/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis and the Gopher protocol
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../key-specs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Command key specifications
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../protocol-spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis serialization protocol specification
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../sentinel-clients/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sentinel client spec
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../signals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis signal handling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../eviction/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Eviction
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../internals/_index/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Internals
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_14" checked>
        
          
          <label class="md-nav__link" for="__nav_10_14" id="__nav_10_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modules
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_14_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_14">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Redis modules API
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Redis modules API
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#loading-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Loading modules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-simplest-module-you-can-write" class="md-nav__link">
    <span class="md-ellipsis">
      The simplest module you can write
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Module initialization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      Module cleanup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-and-dependencies-of-a-redis-module" class="md-nav__link">
    <span class="md-ellipsis">
      Setup and dependencies of a Redis module
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#passing-configuration-parameters-to-redis-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Passing configuration parameters to Redis modules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Passing configuration parameters to Redis modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#working-with-redismodulestring-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Working with RedisModuleString objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-strings-from-numbers-or-parsing-strings-as-numbers" class="md-nav__link">
    <span class="md-ellipsis">
      Creating strings from numbers or parsing strings as numbers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-redis-keys-from-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Accessing Redis keys from modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calling-redis-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Calling Redis commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#working-with-redismodulecallreply-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Working with RedisModuleCallReply objects.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#releasing-call-reply-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Releasing call reply objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-values-from-redis-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Returning values from Redis commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-arrays-with-dynamic-length" class="md-nav__link">
    <span class="md-ellipsis">
      Returning arrays with dynamic length
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arity-and-type-checks" class="md-nav__link">
    <span class="md-ellipsis">
      Arity and type checks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#low-level-access-to-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Low level access to keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-key-type" class="md-nav__link">
    <span class="md-ellipsis">
      Getting the key type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-new-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Creating new keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deleting-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Deleting keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-key-expires-ttls" class="md-nav__link">
    <span class="md-ellipsis">
      Managing key expires (TTLs)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtaining-the-length-of-values" class="md-nav__link">
    <span class="md-ellipsis">
      Obtaining the length of values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#string-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      String type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      List type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      Set type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sorted-set-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      Sorted set type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hash-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      Hash type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iterating-aggregated-values" class="md-nav__link">
    <span class="md-ellipsis">
      Iterating aggregated values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicating-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Replicating commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-memory-management" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic memory management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocating-memory-into-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Allocating memory into modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pool-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      Pool allocator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-commands-compatible-with-redis-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      Writing commands compatible with Redis Cluster
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../modules-api-ref/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modules API reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../modules-blocking-ops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis modules and blocking commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../modules-native-types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modules API for native types
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#loading-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Loading modules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-simplest-module-you-can-write" class="md-nav__link">
    <span class="md-ellipsis">
      The simplest module you can write
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Module initialization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#module-cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      Module cleanup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-and-dependencies-of-a-redis-module" class="md-nav__link">
    <span class="md-ellipsis">
      Setup and dependencies of a Redis module
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#passing-configuration-parameters-to-redis-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Passing configuration parameters to Redis modules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Passing configuration parameters to Redis modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#working-with-redismodulestring-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Working with RedisModuleString objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-strings-from-numbers-or-parsing-strings-as-numbers" class="md-nav__link">
    <span class="md-ellipsis">
      Creating strings from numbers or parsing strings as numbers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-redis-keys-from-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Accessing Redis keys from modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calling-redis-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Calling Redis commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#working-with-redismodulecallreply-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Working with RedisModuleCallReply objects.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#releasing-call-reply-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Releasing call reply objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-values-from-redis-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Returning values from Redis commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-arrays-with-dynamic-length" class="md-nav__link">
    <span class="md-ellipsis">
      Returning arrays with dynamic length
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arity-and-type-checks" class="md-nav__link">
    <span class="md-ellipsis">
      Arity and type checks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#low-level-access-to-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Low level access to keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-key-type" class="md-nav__link">
    <span class="md-ellipsis">
      Getting the key type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-new-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Creating new keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deleting-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Deleting keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-key-expires-ttls" class="md-nav__link">
    <span class="md-ellipsis">
      Managing key expires (TTLs)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtaining-the-length-of-values" class="md-nav__link">
    <span class="md-ellipsis">
      Obtaining the length of values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#string-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      String type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      List type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      Set type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sorted-set-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      Sorted set type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hash-type-api" class="md-nav__link">
    <span class="md-ellipsis">
      Hash type API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iterating-aggregated-values" class="md-nav__link">
    <span class="md-ellipsis">
      Iterating aggregated values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicating-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Replicating commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-memory-management" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic memory management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocating-memory-into-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Allocating memory into modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pool-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      Pool allocator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-commands-compatible-with-redis-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      Writing commands compatible with Redis Cluster
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/EanYang7/redis-doc/tree/main/docs/8-reference/modules/_index.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/EanYang7/redis-doc/tree/main/docs/8-reference/modules/_index.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
    </a>
  


<p>The modules documentation is composed of the following pages:</p>
<ul>
<li>Introduction to Redis modules (this file). An overview about Redis Modules system and API. It's a good idea to start your reading here.</li>
<li><a href="/topics/modules-native-types">Implementing native data types</a> covers the implementation of native data types into modules.</li>
<li><a href="/topics/modules-blocking-ops">Blocking operations</a> shows how to write blocking commands that will not reply immediately, but will block the client, without blocking the Redis server, and will provide a reply whenever will be possible.</li>
<li><a href="/topics/modules-api-ref">Redis modules API reference</a> is generated from module.c top comments of RedisModule functions. It is a good reference in order to understand how each function works.</li>
</ul>
<p>Redis modules make it possible to extend Redis functionality using external
modules, rapidly implementing new Redis commands with features
similar to what can be done inside the core itself.</p>
<p>Redis modules are dynamic libraries that can be loaded into Redis at
startup, or using the <code>MODULE LOAD</code> command. Redis exports a C API, in the
form of a single C header file called <code>redismodule.h</code>. Modules are meant
to be written in C, however it will be possible to use C++ or other languages
that have C binding functionalities.</p>
<p>Modules are designed in order to be loaded into different versions of Redis,
so a given module does not need to be designed, or recompiled, in order to
run with a specific version of Redis. For this reason, the module will
register to the Redis core using a specific API version. The current API
version is "1".</p>
<p>This document is about an alpha version of Redis modules. API, functionalities
and other details may change in the future.</p>
<h2 id="loading-modules">Loading modules<a class="headerlink" href="#loading-modules" title="Permanent link">⚓︎</a></h2>
<p>In order to test the module you are developing, you can load the module
using the following <code>redis.conf</code> configuration directive:</p>
<div class="highlight"><pre><span></span><code>loadmodule /path/to/mymodule.so
</code></pre></div>
<p>It is also possible to load a module at runtime using the following command:</p>
<div class="highlight"><pre><span></span><code>MODULE LOAD /path/to/mymodule.so
</code></pre></div>
<p>In order to list all loaded modules, use:</p>
<div class="highlight"><pre><span></span><code>MODULE LIST
</code></pre></div>
<p>Finally, you can unload (and later reload if you wish) a module using the
following command:</p>
<div class="highlight"><pre><span></span><code>MODULE UNLOAD mymodule
</code></pre></div>
<p>Note that <code>mymodule</code> above is not the filename without the <code>.so</code> suffix, but
instead, the name the module used to register itself into the Redis core.
The name can be obtained using <code>MODULE LIST</code>. However it is good practice
that the filename of the dynamic library is the same as the name the module
uses to register itself into the Redis core.</p>
<h2 id="the-simplest-module-you-can-write">The simplest module you can write<a class="headerlink" href="#the-simplest-module-you-can-write" title="Permanent link">⚓︎</a></h2>
<p>In order to show the different parts of a module, here we'll show a very
simple module that implements a command that outputs a random number.</p>
<div class="highlight"><pre><span></span><code>#include &quot;redismodule.h&quot;
#include &lt;stdlib.h&gt;

int HelloworldRand_RedisCommand(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) {
    RedisModule_ReplyWithLongLong(ctx,rand());
    return REDISMODULE_OK;
}

int RedisModule_OnLoad(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) {
    if (RedisModule_Init(ctx,&quot;helloworld&quot;,1,REDISMODULE_APIVER_1)
        == REDISMODULE_ERR) return REDISMODULE_ERR;

    if (RedisModule_CreateCommand(ctx,&quot;helloworld.rand&quot;,
        HelloworldRand_RedisCommand, &quot;fast random&quot;,
        0, 0, 0) == REDISMODULE_ERR)
        return REDISMODULE_ERR;

    return REDISMODULE_OK;
}
</code></pre></div>
<p>The example module has two functions. One implements a command called
HELLOWORLD.RAND. This function is specific of that module. However the
other function called <code>RedisModule_OnLoad()</code> must be present in each
Redis module. It is the entry point for the module to be initialized,
register its commands, and potentially other private data structures
it uses.</p>
<p>Note that it is a good idea for modules to call commands with the
name of the module followed by a dot, and finally the command name,
like in the case of <code>HELLOWORLD.RAND</code>. This way it is less likely to
have collisions.</p>
<p>Note that if different modules have colliding commands, they'll not be
able to work in Redis at the same time, since the function
<code>RedisModule_CreateCommand</code> will fail in one of the modules, so the module
loading will abort returning an error condition.</p>
<h2 id="module-initialization">Module initialization<a class="headerlink" href="#module-initialization" title="Permanent link">⚓︎</a></h2>
<p>The above example shows the usage of the function <code>RedisModule_Init()</code>.
It should be the first function called by the module <code>OnLoad</code> function.
The following is the function prototype:</p>
<div class="highlight"><pre><span></span><code>int RedisModule_Init(RedisModuleCtx *ctx, const char *modulename,
                     int module_version, int api_version);
</code></pre></div>
<p>The <code>Init</code> function announces the Redis core that the module has a given
name, its version (that is reported by <code>MODULE LIST</code>), and that is willing
to use a specific version of the API.</p>
<p>If the API version is wrong, the name is already taken, or there are other
similar errors, the function will return <code>REDISMODULE_ERR</code>, and the module
<code>OnLoad</code> function should return ASAP with an error.</p>
<p>Before the <code>Init</code> function is called, no other API function can be called,
otherwise the module will segfault and the Redis instance will crash.</p>
<p>The second function called, <code>RedisModule_CreateCommand</code>, is used in order
to register commands into the Redis core. The following is the prototype:</p>
<div class="highlight"><pre><span></span><code>int RedisModule_CreateCommand(RedisModuleCtx *ctx, const char *name,
                              RedisModuleCmdFunc cmdfunc, const char *strflags,
                              int firstkey, int lastkey, int keystep);
</code></pre></div>
<p>As you can see, most Redis modules API calls all take as first argument
the <code>context</code> of the module, so that they have a reference to the module
calling it, to the command and client executing a given command, and so forth.</p>
<p>To create a new command, the above function needs the context, the command's
name, a pointer to the function implementing the command, the command's flags
and the positions of key names in the command's arguments.</p>
<p>The function that implements the command must have the following prototype:</p>
<div class="highlight"><pre><span></span><code>int mycommand(RedisModuleCtx *ctx, RedisModuleString **argv, int argc);
</code></pre></div>
<p>The command function arguments are just the context, that will be passed
to all the other API calls, the command argument vector, and total number
of arguments, as passed by the user.</p>
<p>As you can see, the arguments are provided as pointers to a specific data
type, the <code>RedisModuleString</code>. This is an opaque data type you have API
functions to access and use, direct access to its fields is never needed.</p>
<p>Zooming into the example command implementation, we can find another call:</p>
<div class="highlight"><pre><span></span><code>int RedisModule_ReplyWithLongLong(RedisModuleCtx *ctx, long long integer);
</code></pre></div>
<p>This function returns an integer to the client that invoked the command,
exactly like other Redis commands do, like for example <code>INCR</code> or <code>SCARD</code>.</p>
<h2 id="module-cleanup">Module cleanup<a class="headerlink" href="#module-cleanup" title="Permanent link">⚓︎</a></h2>
<p>In most cases, there is no need for special cleanup.
When a module is unloaded, Redis will automatically unregister commands and
unsubscribe from notifications.
However in the case where a module contains some persistent memory or
configuration, a module may include an optional <code>RedisModule_OnUnload</code>
function.
If a module provides this function, it will be invoked during the module unload
process.
The following is the function prototype:</p>
<div class="highlight"><pre><span></span><code>int RedisModule_OnUnload(RedisModuleCtx *ctx);
</code></pre></div>
<p>The <code>OnUnload</code> function may prevent module unloading by returning
<code>REDISMODULE_ERR</code>.
Otherwise, <code>REDISMODULE_OK</code> should be returned.</p>
<h2 id="setup-and-dependencies-of-a-redis-module">Setup and dependencies of a Redis module<a class="headerlink" href="#setup-and-dependencies-of-a-redis-module" title="Permanent link">⚓︎</a></h2>
<p>Redis modules don't depend on Redis or some other library, nor they
need to be compiled with a specific <code>redismodule.h</code> file. In order
to create a new module, just copy a recent version of <code>redismodule.h</code>
in your source tree, link all the libraries you want, and create
a dynamic library having the <code>RedisModule_OnLoad()</code> function symbol
exported.</p>
<p>The module will be able to load into different versions of Redis.</p>
<p>A module can be designed to support both newer and older Redis versions where certain API functions are not available in all versions.
If an API function is not implemented in the currently running Redis version, the function pointer is set to NULL.
This allows the module to check if a function exists before using it:</p>
<div class="highlight"><pre><span></span><code>if (RedisModule_SetCommandInfo != NULL) {
    RedisModule_SetCommandInfo(cmd, &amp;info);
}
</code></pre></div>
<p>In recent versions of <code>redismodule.h</code>, a convenience macro <code>RMAPI_FUNC_SUPPORTED(funcname)</code> is defined.
Using the macro or just comparing with NULL is a matter of personal preference.</p>
<h1 id="passing-configuration-parameters-to-redis-modules">Passing configuration parameters to Redis modules<a class="headerlink" href="#passing-configuration-parameters-to-redis-modules" title="Permanent link">⚓︎</a></h1>
<p>When the module is loaded with the <code>MODULE LOAD</code> command, or using the
<code>loadmodule</code> directive in the <code>redis.conf</code> file, the user is able to pass
configuration parameters to the module by adding arguments after the module
file name:</p>
<div class="highlight"><pre><span></span><code>loadmodule mymodule.so foo bar 1234
</code></pre></div>
<p>In the above example the strings <code>foo</code>, <code>bar</code> and <code>1234</code> will be passed
to the module <code>OnLoad()</code> function in the <code>argv</code> argument as an array
of RedisModuleString pointers. The number of arguments passed is into <code>argc</code>.</p>
<p>The way you can access those strings will be explained in the rest of this
document. Normally the module will store the module configuration parameters
in some <code>static</code> global variable that can be accessed module wide, so that
the configuration can change the behavior of different commands.</p>
<h2 id="working-with-redismodulestring-objects">Working with RedisModuleString objects<a class="headerlink" href="#working-with-redismodulestring-objects" title="Permanent link">⚓︎</a></h2>
<p>The command argument vector <code>argv</code> passed to module commands, and the
return value of other module APIs functions, are of type <code>RedisModuleString</code>.</p>
<p>Usually you directly pass module strings to other API calls, however sometimes
you may need to directly access the string object.</p>
<p>There are a few functions in order to work with string objects:</p>
<div class="highlight"><pre><span></span><code>const char *RedisModule_StringPtrLen(RedisModuleString *string, size_t *len);
</code></pre></div>
<p>The above function accesses a string by returning its pointer and setting its
length in <code>len</code>.
You should never write to a string object pointer, as you can see from the
<code>const</code> pointer qualifier.</p>
<p>However, if you want, you can create new string objects using the following
API:</p>
<div class="highlight"><pre><span></span><code>RedisModuleString *RedisModule_CreateString(RedisModuleCtx *ctx, const char *ptr, size_t len);
</code></pre></div>
<p>The string returned by the above command must be freed using a corresponding
call to <code>RedisModule_FreeString()</code>:</p>
<div class="highlight"><pre><span></span><code>void RedisModule_FreeString(RedisModuleString *str);
</code></pre></div>
<p>However if you want to avoid having to free strings, the automatic memory
management, covered later in this document, can be a good alternative, by
doing it for you.</p>
<p>Note that the strings provided via the argument vector <code>argv</code> never need
to be freed. You only need to free new strings you create, or new strings
returned by other APIs, where it is specified that the returned string must
be freed.</p>
<h2 id="creating-strings-from-numbers-or-parsing-strings-as-numbers">Creating strings from numbers or parsing strings as numbers<a class="headerlink" href="#creating-strings-from-numbers-or-parsing-strings-as-numbers" title="Permanent link">⚓︎</a></h2>
<p>Creating a new string from an integer is a very common operation, so there
is a function to do this:</p>
<div class="highlight"><pre><span></span><code>RedisModuleString *mystr = RedisModule_CreateStringFromLongLong(ctx,10);
</code></pre></div>
<p>Similarly in order to parse a string as a number:</p>
<div class="highlight"><pre><span></span><code>long long myval;
if (RedisModule_StringToLongLong(ctx,argv[1],&amp;myval) == REDISMODULE_OK) {
    /* Do something with &#39;myval&#39; */
}
</code></pre></div>
<h2 id="accessing-redis-keys-from-modules">Accessing Redis keys from modules<a class="headerlink" href="#accessing-redis-keys-from-modules" title="Permanent link">⚓︎</a></h2>
<p>Most Redis modules, in order to be useful, have to interact with the Redis
data space (this is not always true, for example an ID generator may
never touch Redis keys). Redis modules have two different APIs in order to
access the Redis data space, one is a low level API that provides very
fast access and a set of functions to manipulate Redis data structures.
The other API is more high level, and allows to call Redis commands and
fetch the result, similarly to how Lua scripts access Redis.</p>
<p>The high level API is also useful in order to access Redis functionalities
that are not available as APIs.</p>
<p>In general modules developers should prefer the low level API, because commands
implemented using the low level API run at a speed comparable to the speed
of native Redis commands. However there are definitely use cases for the
higher level API. For example often the bottleneck could be processing the
data and not accessing it.</p>
<p>Also note that sometimes using the low level API is not harder compared to
the higher level one.</p>
<h2 id="calling-redis-commands">Calling Redis commands<a class="headerlink" href="#calling-redis-commands" title="Permanent link">⚓︎</a></h2>
<p>The high level API to access Redis is the sum of the <code>RedisModule_Call()</code>
function, together with the functions needed in order to access the
reply object returned by <code>Call()</code>.</p>
<p><code>RedisModule_Call</code> uses a special calling convention, with a format specifier
that is used to specify what kind of objects you are passing as arguments
to the function.</p>
<p>Redis commands are invoked just using a command name and a list of arguments.
However when calling commands, the arguments may originate from different
kind of strings: null-terminated C strings, RedisModuleString objects as
received from the <code>argv</code> parameter in the command implementation, binary
safe C buffers with a pointer and a length, and so forth.</p>
<p>For example if I want to call <code>INCRBY</code> using a first argument (the key)
a string received in the argument vector <code>argv</code>, which is an array
of RedisModuleString object pointers, and a C string representing the
number "10" as second argument (the increment), I'll use the following
function call:</p>
<div class="highlight"><pre><span></span><code>RedisModuleCallReply *reply;
reply = RedisModule_Call(ctx,&quot;INCRBY&quot;,&quot;sc&quot;,argv[1],&quot;10&quot;);
</code></pre></div>
<p>The first argument is the context, and the second is always a null terminated
C string with the command name. The third argument is the format specifier
where each character corresponds to the type of the arguments that will follow.
In the above case <code>"sc"</code> means a RedisModuleString object, and a null
terminated C string. The other arguments are just the two arguments as
specified. In fact <code>argv[1]</code> is a RedisModuleString and <code>"10"</code> is a null
terminated C string.</p>
<p>This is the full list of format specifiers:</p>
<ul>
<li><strong>c</strong> -- Null terminated C string pointer.</li>
<li><strong>b</strong> -- C buffer, two arguments needed: C string pointer and <code>size_t</code> length.</li>
<li><strong>s</strong> -- RedisModuleString as received in <code>argv</code> or by other Redis module APIs returning a RedisModuleString object.</li>
<li><strong>l</strong> -- Long long integer.</li>
<li><strong>v</strong> -- Array of RedisModuleString objects.</li>
<li><strong>!</strong> -- This modifier just tells the function to replicate the command to replicas and AOF. It is ignored from the point of view of arguments parsing.</li>
<li><strong>A</strong> -- This modifier, when <code>!</code> is given, tells to suppress AOF propagation: the command will be propagated only to replicas.</li>
<li><strong>R</strong> -- This modifier, when <code>!</code> is given, tells to suppress replicas propagation: the command will be propagated only to the AOF if enabled.</li>
</ul>
<p>The function returns a <code>RedisModuleCallReply</code> object on success, on
error NULL is returned.</p>
<p>NULL is returned when the command name is invalid, the format specifier uses
characters that are not recognized, or when the command is called with the
wrong number of arguments. In the above cases the <code>errno</code> var is set to <code>EINVAL</code>. NULL is also returned when, in an instance with Cluster enabled, the target
keys are about non local hash slots. In this case <code>errno</code> is set to <code>EPERM</code>.</p>
<h2 id="working-with-redismodulecallreply-objects">Working with RedisModuleCallReply objects.<a class="headerlink" href="#working-with-redismodulecallreply-objects" title="Permanent link">⚓︎</a></h2>
<p><code>RedisModuleCall</code> returns reply objects that can be accessed using the
<code>RedisModule_CallReply*</code> family of functions.</p>
<p>In order to obtain the type or reply (corresponding to one of the data types
supported by the Redis protocol), the function <code>RedisModule_CallReplyType()</code>
is used:</p>
<div class="highlight"><pre><span></span><code>reply = RedisModule_Call(ctx,&quot;INCRBY&quot;,&quot;sc&quot;,argv[1],&quot;10&quot;);
if (RedisModule_CallReplyType(reply) == REDISMODULE_REPLY_INTEGER) {
    long long myval = RedisModule_CallReplyInteger(reply);
    /* Do something with myval. */
}
</code></pre></div>
<p>Valid reply types are:</p>
<ul>
<li><code>REDISMODULE_REPLY_STRING</code> Bulk string or status replies.</li>
<li><code>REDISMODULE_REPLY_ERROR</code> Errors.</li>
<li><code>REDISMODULE_REPLY_INTEGER</code> Signed 64 bit integers.</li>
<li><code>REDISMODULE_REPLY_ARRAY</code> Array of replies.</li>
<li><code>REDISMODULE_REPLY_NULL</code> NULL reply.</li>
</ul>
<p>Strings, errors and arrays have an associated length. For strings and errors
the length corresponds to the length of the string. For arrays the length
is the number of elements. To obtain the reply length the following function
is used:</p>
<div class="highlight"><pre><span></span><code>size_t reply_len = RedisModule_CallReplyLength(reply);
</code></pre></div>
<p>In order to obtain the value of an integer reply, the following function is used, as already shown in the example above:</p>
<div class="highlight"><pre><span></span><code>long long reply_integer_val = RedisModule_CallReplyInteger(reply);
</code></pre></div>
<p>Called with a reply object of the wrong type, the above function always
returns <code>LLONG_MIN</code>.</p>
<p>Sub elements of array replies are accessed this way:</p>
<div class="highlight"><pre><span></span><code>RedisModuleCallReply *subreply;
subreply = RedisModule_CallReplyArrayElement(reply,idx);
</code></pre></div>
<p>The above function returns NULL if you try to access out of range elements.</p>
<p>Strings and errors (which are like strings but with a different type) can
be accessed using in the following way, making sure to never write to
the resulting pointer (that is returned as a <code>const</code> pointer so that
misusing must be pretty explicit):</p>
<div class="highlight"><pre><span></span><code>size_t len;
char *ptr = RedisModule_CallReplyStringPtr(reply,&amp;len);
</code></pre></div>
<p>If the reply type is not a string or an error, NULL is returned.</p>
<p>RedisCallReply objects are not the same as module string objects
(RedisModuleString types). However sometimes you may need to pass replies
of type string or integer, to API functions expecting a module string.</p>
<p>When this is the case, you may want to evaluate if using the low level
API could be a simpler way to implement your command, or you can use
the following function in order to create a new string object from a
call reply of type string, error or integer:</p>
<div class="highlight"><pre><span></span><code>RedisModuleString *mystr = RedisModule_CreateStringFromCallReply(myreply);
</code></pre></div>
<p>If the reply is not of the right type, NULL is returned.
The returned string object should be released with <code>RedisModule_FreeString()</code>
as usually, or by enabling automatic memory management (see corresponding
section).</p>
<h2 id="releasing-call-reply-objects">Releasing call reply objects<a class="headerlink" href="#releasing-call-reply-objects" title="Permanent link">⚓︎</a></h2>
<p>Reply objects must be freed using <code>RedisModule_FreeCallReply</code>. For arrays,
you need to free only the top level reply, not the nested replies.
Currently the module implementation provides a protection in order to avoid
crashing if you free a nested reply object for error, however this feature
is not guaranteed to be here forever, so should not be considered part
of the API.</p>
<p>If you use automatic memory management (explained later in this document)
you don't need to free replies (but you still could if you wish to release
memory ASAP).</p>
<h2 id="returning-values-from-redis-commands">Returning values from Redis commands<a class="headerlink" href="#returning-values-from-redis-commands" title="Permanent link">⚓︎</a></h2>
<p>Like normal Redis commands, new commands implemented via modules must be
able to return values to the caller. The API exports a set of functions for
this goal, in order to return the usual types of the Redis protocol, and
arrays of such types as elements. Also errors can be returned with any
error string and code (the error code is the initial uppercase letters in
the error message, like the "BUSY" string in the "BUSY the sever is busy" error
message).</p>
<p>All the functions to send a reply to the client are called
<code>RedisModule_ReplyWith&lt;something&gt;</code>.</p>
<p>To return an error, use:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplyWithError(RedisModuleCtx *ctx, const char *err);
</code></pre></div>
<p>There is a predefined error string for key of wrong type errors:</p>
<div class="highlight"><pre><span></span><code>REDISMODULE_ERRORMSG_WRONGTYPE
</code></pre></div>
<p>Example usage:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplyWithError(ctx,&quot;ERR invalid arguments&quot;);
</code></pre></div>
<p>We already saw how to reply with a <code>long long</code> in the examples above:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplyWithLongLong(ctx,12345);
</code></pre></div>
<p>To reply with a simple string, that can't contain binary values or newlines,
(so it's suitable to send small words, like "OK") we use:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplyWithSimpleString(ctx,&quot;OK&quot;);
</code></pre></div>
<p>It's possible to reply with "bulk strings" that are binary safe, using
two different functions:</p>
<div class="highlight"><pre><span></span><code>int RedisModule_ReplyWithStringBuffer(RedisModuleCtx *ctx, const char *buf, size_t len);

int RedisModule_ReplyWithString(RedisModuleCtx *ctx, RedisModuleString *str);
</code></pre></div>
<p>The first function gets a C pointer and length. The second a RedisModuleString
object. Use one or the other depending on the source type you have at hand.</p>
<p>In order to reply with an array, you just need to use a function to emit the
array length, followed by as many calls to the above functions as the number
of elements of the array are:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplyWithArray(ctx,2);
RedisModule_ReplyWithStringBuffer(ctx,&quot;age&quot;,3);
RedisModule_ReplyWithLongLong(ctx,22);
</code></pre></div>
<p>To return nested arrays is easy, your nested array element just uses another
call to <code>RedisModule_ReplyWithArray()</code> followed by the calls to emit the
sub array elements.</p>
<h2 id="returning-arrays-with-dynamic-length">Returning arrays with dynamic length<a class="headerlink" href="#returning-arrays-with-dynamic-length" title="Permanent link">⚓︎</a></h2>
<p>Sometimes it is not possible to know beforehand the number of items of
an array. As an example, think of a Redis module implementing a FACTOR
command that given a number outputs the prime factors. Instead of
factorializing the number, storing the prime factors into an array, and
later produce the command reply, a better solution is to start an array
reply where the length is not known, and set it later. This is accomplished
with a special argument to <code>RedisModule_ReplyWithArray()</code>:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplyWithArray(ctx, REDISMODULE_POSTPONED_LEN);
</code></pre></div>
<p>The above call starts an array reply so we can use other <code>ReplyWith</code> calls
in order to produce the array items. Finally in order to set the length,
use the following call:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplySetArrayLength(ctx, number_of_items);
</code></pre></div>
<p>In the case of the FACTOR command, this translates to some code similar
to this:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplyWithArray(ctx, REDISMODULE_POSTPONED_LEN);
number_of_factors = 0;
while(still_factors) {
    RedisModule_ReplyWithLongLong(ctx, some_factor);
    number_of_factors++;
}
RedisModule_ReplySetArrayLength(ctx, number_of_factors);
</code></pre></div>
<p>Another common use case for this feature is iterating over the arrays of
some collection and only returning the ones passing some kind of filtering.</p>
<p>It is possible to have multiple nested arrays with postponed reply.
Each call to <code>SetArray()</code> will set the length of the latest corresponding
call to <code>ReplyWithArray()</code>:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplyWithArray(ctx, REDISMODULE_POSTPONED_LEN);
... generate 100 elements ...
RedisModule_ReplyWithArray(ctx, REDISMODULE_POSTPONED_LEN);
... generate 10 elements ...
RedisModule_ReplySetArrayLength(ctx, 10);
RedisModule_ReplySetArrayLength(ctx, 100);
</code></pre></div>
<p>This creates a 100 items array having as last element a 10 items array.</p>
<h2 id="arity-and-type-checks">Arity and type checks<a class="headerlink" href="#arity-and-type-checks" title="Permanent link">⚓︎</a></h2>
<p>Often commands need to check that the number of arguments and type of the key
is correct. In order to report a wrong arity, there is a specific function
called <code>RedisModule_WrongArity()</code>. The usage is trivial:</p>
<div class="highlight"><pre><span></span><code>if (argc != 2) return RedisModule_WrongArity(ctx);
</code></pre></div>
<p>Checking for the wrong type involves opening the key and checking the type:</p>
<div class="highlight"><pre><span></span><code>RedisModuleKey *key = RedisModule_OpenKey(ctx,argv[1],
    REDISMODULE_READ|REDISMODULE_WRITE);

int keytype = RedisModule_KeyType(key);
if (keytype != REDISMODULE_KEYTYPE_STRING &amp;&amp;
    keytype != REDISMODULE_KEYTYPE_EMPTY)
{
    RedisModule_CloseKey(key);
    return RedisModule_ReplyWithError(ctx,REDISMODULE_ERRORMSG_WRONGTYPE);
}
</code></pre></div>
<p>Note that you often want to proceed with a command both if the key
is of the expected type, or if it's empty.</p>
<h2 id="low-level-access-to-keys">Low level access to keys<a class="headerlink" href="#low-level-access-to-keys" title="Permanent link">⚓︎</a></h2>
<p>Low level access to keys allow to perform operations on value objects associated
to keys directly, with a speed similar to what Redis uses internally to
implement the built-in commands.</p>
<p>Once a key is opened, a key pointer is returned that will be used with all the
other low level API calls in order to perform operations on the key or its
associated value.</p>
<p>Because the API is meant to be very fast, it cannot do too many run-time
checks, so the user must be aware of certain rules to follow:</p>
<ul>
<li>Opening the same key multiple times where at least one instance is opened for writing, is undefined and may lead to crashes.</li>
<li>While a key is open, it should only be accessed via the low level key API. For example opening a key, then calling DEL on the same key using the <code>RedisModule_Call()</code> API will result into a crash. However it is safe to open a key, perform some operation with the low level API, closing it, then using other APIs to manage the same key, and later opening it again to do some more work.</li>
</ul>
<p>In order to open a key the <code>RedisModule_OpenKey</code> function is used. It returns
a key pointer, that we'll use with all the next calls to access and modify
the value:</p>
<div class="highlight"><pre><span></span><code>RedisModuleKey *key;
key = RedisModule_OpenKey(ctx,argv[1],REDISMODULE_READ);
</code></pre></div>
<p>The second argument is the key name, that must be a <code>RedisModuleString</code> object.
The third argument is the mode: <code>REDISMODULE_READ</code> or <code>REDISMODULE_WRITE</code>.
It is possible to use <code>|</code> to bitwise OR the two modes to open the key in
both modes. Currently a key opened for writing can also be accessed for reading
but this is to be considered an implementation detail. The right mode should
be used in sane modules.</p>
<p>You can open non existing keys for writing, since the keys will be created
when an attempt to write to the key is performed. However when opening keys
just for reading, <code>RedisModule_OpenKey</code> will return NULL if the key does not
exist.</p>
<p>Once you are done using a key, you can close it with:</p>
<div class="highlight"><pre><span></span><code>RedisModule_CloseKey(key);
</code></pre></div>
<p>Note that if automatic memory management is enabled, you are not forced to
close keys. When the module function returns, Redis will take care to close
all the keys which are still open.</p>
<h2 id="getting-the-key-type">Getting the key type<a class="headerlink" href="#getting-the-key-type" title="Permanent link">⚓︎</a></h2>
<p>In order to obtain the value of a key, use the <code>RedisModule_KeyType()</code> function:</p>
<div class="highlight"><pre><span></span><code>int keytype = RedisModule_KeyType(key);
</code></pre></div>
<p>It returns one of the following values:</p>
<div class="highlight"><pre><span></span><code>REDISMODULE_KEYTYPE_EMPTY
REDISMODULE_KEYTYPE_STRING
REDISMODULE_KEYTYPE_LIST
REDISMODULE_KEYTYPE_HASH
REDISMODULE_KEYTYPE_SET
REDISMODULE_KEYTYPE_ZSET
</code></pre></div>
<p>The above are just the usual Redis key types, with the addition of an empty
type, that signals the key pointer is associated with an empty key that
does not yet exists.</p>
<h2 id="creating-new-keys">Creating new keys<a class="headerlink" href="#creating-new-keys" title="Permanent link">⚓︎</a></h2>
<p>To create a new key, open it for writing and then write to it using one
of the key writing functions. Example:</p>
<div class="highlight"><pre><span></span><code>RedisModuleKey *key;
key = RedisModule_OpenKey(ctx,argv[1],REDISMODULE_WRITE);
if (RedisModule_KeyType(key) == REDISMODULE_KEYTYPE_EMPTY) {
    RedisModule_StringSet(key,argv[2]);
}
</code></pre></div>
<h2 id="deleting-keys">Deleting keys<a class="headerlink" href="#deleting-keys" title="Permanent link">⚓︎</a></h2>
<p>Just use:</p>
<div class="highlight"><pre><span></span><code>RedisModule_DeleteKey(key);
</code></pre></div>
<p>The function returns <code>REDISMODULE_ERR</code> if the key is not open for writing.
Note that after a key gets deleted, it is setup in order to be targeted
by new key commands. For example <code>RedisModule_KeyType()</code> will return it is
an empty key, and writing to it will create a new key, possibly of another
type (depending on the API used).</p>
<h2 id="managing-key-expires-ttls">Managing key expires (TTLs)<a class="headerlink" href="#managing-key-expires-ttls" title="Permanent link">⚓︎</a></h2>
<p>To control key expires two functions are provided, that are able to set,
modify, get, and unset the time to live associated with a key.</p>
<p>One function is used in order to query the current expire of an open key:</p>
<div class="highlight"><pre><span></span><code>mstime_t RedisModule_GetExpire(RedisModuleKey *key);
</code></pre></div>
<p>The function returns the time to live of the key in milliseconds, or
<code>REDISMODULE_NO_EXPIRE</code> as a special value to signal the key has no associated
expire or does not exist at all (you can differentiate the two cases checking
if the key type is <code>REDISMODULE_KEYTYPE_EMPTY</code>).</p>
<p>In order to change the expire of a key the following function is used instead:</p>
<div class="highlight"><pre><span></span><code>int RedisModule_SetExpire(RedisModuleKey *key, mstime_t expire);
</code></pre></div>
<p>When called on a non existing key, <code>REDISMODULE_ERR</code> is returned, because
the function can only associate expires to existing open keys (non existing
open keys are only useful in order to create new values with data type
specific write operations).</p>
<p>Again the <code>expire</code> time is specified in milliseconds. If the key has currently
no expire, a new expire is set. If the key already have an expire, it is
replaced with the new value.</p>
<p>If the key has an expire, and the special value <code>REDISMODULE_NO_EXPIRE</code> is
used as a new expire, the expire is removed, similarly to the Redis
<code>PERSIST</code> command. In case the key was already persistent, no operation is
performed.</p>
<h2 id="obtaining-the-length-of-values">Obtaining the length of values<a class="headerlink" href="#obtaining-the-length-of-values" title="Permanent link">⚓︎</a></h2>
<p>There is a single function in order to retrieve the length of the value
associated to an open key. The returned length is value-specific, and is
the string length for strings, and the number of elements for the aggregated
data types (how many elements there is in a list, set, sorted set, hash).</p>
<div class="highlight"><pre><span></span><code>size_t len = RedisModule_ValueLength(key);
</code></pre></div>
<p>If the key does not exist, 0 is returned by the function:</p>
<h2 id="string-type-api">String type API<a class="headerlink" href="#string-type-api" title="Permanent link">⚓︎</a></h2>
<p>Setting a new string value, like the Redis <code>SET</code> command does, is performed
using:</p>
<div class="highlight"><pre><span></span><code>int RedisModule_StringSet(RedisModuleKey *key, RedisModuleString *str);
</code></pre></div>
<p>The function works exactly like the Redis <code>SET</code> command itself, that is, if
there is a prior value (of any type) it will be deleted.</p>
<p>Accessing existing string values is performed using DMA (direct memory
access) for speed. The API will return a pointer and a length, so that's
possible to access and, if needed, modify the string directly.</p>
<div class="highlight"><pre><span></span><code>size_t len, j;
char *myptr = RedisModule_StringDMA(key,&amp;len,REDISMODULE_WRITE);
for (j = 0; j &lt; len; j++) myptr[j] = &#39;A&#39;;
</code></pre></div>
<p>In the above example we write directly on the string. Note that if you want
to write, you must be sure to ask for <code>WRITE</code> mode.</p>
<p>DMA pointers are only valid if no other operations are performed with the key
before using the pointer, after the DMA call.</p>
<p>Sometimes when we want to manipulate strings directly, we need to change
their size as well. For this scope, the <code>RedisModule_StringTruncate</code> function
is used. Example:</p>
<div class="highlight"><pre><span></span><code>RedisModule_StringTruncate(mykey,1024);
</code></pre></div>
<p>The function truncates, or enlarges the string as needed, padding it with
zero bytes if the previous length is smaller than the new length we request.
If the string does not exist since <code>key</code> is associated to an open empty key,
a string value is created and associated to the key.</p>
<p>Note that every time <code>StringTruncate()</code> is called, we need to re-obtain
the DMA pointer again, since the old may be invalid.</p>
<h2 id="list-type-api">List type API<a class="headerlink" href="#list-type-api" title="Permanent link">⚓︎</a></h2>
<p>It's possible to push and pop values from list values:</p>
<div class="highlight"><pre><span></span><code>int RedisModule_ListPush(RedisModuleKey *key, int where, RedisModuleString *ele);
RedisModuleString *RedisModule_ListPop(RedisModuleKey *key, int where);
</code></pre></div>
<p>In both the APIs the <code>where</code> argument specifies if to push or pop from tail
or head, using the following macros:</p>
<div class="highlight"><pre><span></span><code>REDISMODULE_LIST_HEAD
REDISMODULE_LIST_TAIL
</code></pre></div>
<p>Elements returned by <code>RedisModule_ListPop()</code> are like strings created with
<code>RedisModule_CreateString()</code>, they must be released with
<code>RedisModule_FreeString()</code> or by enabling automatic memory management.</p>
<h2 id="set-type-api">Set type API<a class="headerlink" href="#set-type-api" title="Permanent link">⚓︎</a></h2>
<p>Work in progress.</p>
<h2 id="sorted-set-type-api">Sorted set type API<a class="headerlink" href="#sorted-set-type-api" title="Permanent link">⚓︎</a></h2>
<p>Documentation missing, please refer to the top comments inside <code>module.c</code>
for the following functions:</p>
<ul>
<li><code>RedisModule_ZsetAdd</code></li>
<li><code>RedisModule_ZsetIncrby</code></li>
<li><code>RedisModule_ZsetScore</code></li>
<li><code>RedisModule_ZsetRem</code></li>
</ul>
<p>And for the sorted set iterator:</p>
<ul>
<li><code>RedisModule_ZsetRangeStop</code></li>
<li><code>RedisModule_ZsetFirstInScoreRange</code></li>
<li><code>RedisModule_ZsetLastInScoreRange</code></li>
<li><code>RedisModule_ZsetFirstInLexRange</code></li>
<li><code>RedisModule_ZsetLastInLexRange</code></li>
<li><code>RedisModule_ZsetRangeCurrentElement</code></li>
<li><code>RedisModule_ZsetRangeNext</code></li>
<li><code>RedisModule_ZsetRangePrev</code></li>
<li><code>RedisModule_ZsetRangeEndReached</code></li>
</ul>
<h2 id="hash-type-api">Hash type API<a class="headerlink" href="#hash-type-api" title="Permanent link">⚓︎</a></h2>
<p>Documentation missing, please refer to the top comments inside <code>module.c</code>
for the following functions:</p>
<ul>
<li><code>RedisModule_HashSet</code></li>
<li><code>RedisModule_HashGet</code></li>
</ul>
<h2 id="iterating-aggregated-values">Iterating aggregated values<a class="headerlink" href="#iterating-aggregated-values" title="Permanent link">⚓︎</a></h2>
<p>Work in progress.</p>
<h2 id="replicating-commands">Replicating commands<a class="headerlink" href="#replicating-commands" title="Permanent link">⚓︎</a></h2>
<p>If you want to use module commands exactly like normal Redis commands, in the
context of replicated Redis instances, or using the AOF file for persistence,
it is important for module commands to handle their replication in a consistent
way.</p>
<p>When using the higher level APIs to invoke commands, replication happens
automatically if you use the "!" modifier in the format string of
<code>RedisModule_Call()</code> as in the following example:</p>
<div class="highlight"><pre><span></span><code>reply = RedisModule_Call(ctx,&quot;INCRBY&quot;,&quot;!sc&quot;,argv[1],&quot;10&quot;);
</code></pre></div>
<p>As you can see the format specifier is <code>"!sc"</code>. The bang is not parsed as a
format specifier, but it internally flags the command as "must replicate".</p>
<p>If you use the above programming style, there are no problems.
However sometimes things are more complex than that, and you use the low level
API. In this case, if there are no side effects in the command execution, and
it consistently always performs the same work, what is possible to do is to
replicate the command verbatim as the user executed it. To do that, you just
need to call the following function:</p>
<div class="highlight"><pre><span></span><code>RedisModule_ReplicateVerbatim(ctx);
</code></pre></div>
<p>When you use the above API, you should not use any other replication function
since they are not guaranteed to mix well.</p>
<p>However this is not the only option. It's also possible to exactly tell
Redis what commands to replicate as the effect of the command execution, using
an API similar to <code>RedisModule_Call()</code> but that instead of calling the command
sends it to the AOF / replicas stream. Example:</p>
<div class="highlight"><pre><span></span><code>RedisModule_Replicate(ctx,&quot;INCRBY&quot;,&quot;cl&quot;,&quot;foo&quot;,my_increment);
</code></pre></div>
<p>It's possible to call <code>RedisModule_Replicate</code> multiple times, and each
will emit a command. All the sequence emitted is wrapped between a
<code>MULTI/EXEC</code> transaction, so that the AOF and replication effects are the
same as executing a single command.</p>
<p>Note that <code>Call()</code> replication and <code>Replicate()</code> replication have a rule,
in case you want to mix both forms of replication (not necessarily a good
idea if there are simpler approaches). Commands replicated with <code>Call()</code>
are always the first emitted in the final <code>MULTI/EXEC</code> block, while all
the commands emitted with <code>Replicate()</code> will follow.</p>
<h2 id="automatic-memory-management">Automatic memory management<a class="headerlink" href="#automatic-memory-management" title="Permanent link">⚓︎</a></h2>
<p>Normally when writing programs in the C language, programmers need to manage
memory manually. This is why the Redis modules API has functions to release
strings, close open keys, free replies, and so forth.</p>
<p>However given that commands are executed in a contained environment and
with a set of strict APIs, Redis is able to provide automatic memory management
to modules, at the cost of some performance (most of the time, a very low
cost).</p>
<p>When automatic memory management is enabled:</p>
<ol>
<li>You don't need to close open keys.</li>
<li>You don't need to free replies.</li>
<li>You don't need to free RedisModuleString objects.</li>
</ol>
<p>However you can still do it, if you want. For example, automatic memory
management may be active, but inside a loop allocating a lot of strings,
you may still want to free strings no longer used.</p>
<p>In order to enable automatic memory management, just call the following
function at the start of the command implementation:</p>
<div class="highlight"><pre><span></span><code>RedisModule_AutoMemory(ctx);
</code></pre></div>
<p>Automatic memory management is usually the way to go, however experienced
C programmers may not use it in order to gain some speed and memory usage
benefit.</p>
<h2 id="allocating-memory-into-modules">Allocating memory into modules<a class="headerlink" href="#allocating-memory-into-modules" title="Permanent link">⚓︎</a></h2>
<p>Normal C programs use <code>malloc()</code> and <code>free()</code> in order to allocate and
release memory dynamically. While in Redis modules the use of malloc is
not technically forbidden, it is a lot better to use the Redis Modules
specific functions, that are exact replacements for <code>malloc</code>, <code>free</code>,
<code>realloc</code> and <code>strdup</code>. These functions are:</p>
<div class="highlight"><pre><span></span><code>void *RedisModule_Alloc(size_t bytes);
void* RedisModule_Realloc(void *ptr, size_t bytes);
void RedisModule_Free(void *ptr);
void RedisModule_Calloc(size_t nmemb, size_t size);
char *RedisModule_Strdup(const char *str);
</code></pre></div>
<p>They work exactly like their <code>libc</code> equivalent calls, however they use
the same allocator Redis uses, and the memory allocated using these
functions is reported by the <code>INFO</code> command in the memory section, is
accounted when enforcing the <code>maxmemory</code> policy, and in general is
a first citizen of the Redis executable. On the contrary, the method
allocated inside modules with libc <code>malloc()</code> is transparent to Redis.</p>
<p>Another reason to use the modules functions in order to allocate memory
is that, when creating native data types inside modules, the RDB loading
functions can return deserialized strings (from the RDB file) directly
as <code>RedisModule_Alloc()</code> allocations, so they can be used directly to
populate data structures after loading, instead of having to copy them
to the data structure.</p>
<h2 id="pool-allocator">Pool allocator<a class="headerlink" href="#pool-allocator" title="Permanent link">⚓︎</a></h2>
<p>Sometimes in commands implementations, it is required to perform many
small allocations that will be not retained at the end of the command
execution, but are just functional to execute the command itself.</p>
<p>This work can be more easily accomplished using the Redis pool allocator:</p>
<div class="highlight"><pre><span></span><code>void *RedisModule_PoolAlloc(RedisModuleCtx *ctx, size_t bytes);
</code></pre></div>
<p>It works similarly to <code>malloc()</code>, and returns memory aligned to the
next power of two of greater or equal to <code>bytes</code> (for a maximum alignment
of 8 bytes). However it allocates memory in blocks, so it the overhead
of the allocations is small, and more important, the memory allocated
is automatically released when the command returns.</p>
<p>So in general short living allocations are a good candidates for the pool
allocator.</p>
<h2 id="writing-commands-compatible-with-redis-cluster">Writing commands compatible with Redis Cluster<a class="headerlink" href="#writing-commands-compatible-with-redis-cluster" title="Permanent link">⚓︎</a></h2>
<p>Documentation missing, please check the following functions inside <code>module.c</code>:</p>
<div class="highlight"><pre><span></span><code>RedisModule_IsKeysPositionRequest(ctx);
RedisModule_KeyAtPos(ctx,pos);
</code></pre></div>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 25, 2023</span>
      
        <br>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 25, 2023</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../internals/rdd/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Redis design draft #2 (historical)">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                Redis design draft #2 (historical)
              </div>
            </div>
          </a>
        
        
          
          <a href="../modules-api-ref/" class="md-footer__link md-footer__link--next" aria-label="下一页: Modules API reference">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                Modules API reference
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 Ean Yang
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/YQisme" target="_blank" rel="noopener" title="github主页" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://space.bilibili.com/244185393?spm_id_from=333.788.0.0" target="_blank" rel="noopener" title="b站主页" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M488.6 104.1c16.7 18.1 24.4 39.7 23.3 65.7v202.4c-.4 26.4-9.2 48.1-26.5 65.1-17.2 17-39.1 25.9-65.5 26.7H92.02c-26.45-.8-48.21-9.8-65.28-27.2C9.682 419.4.767 396.5 0 368.2V169.8c.767-26 9.682-47.6 26.74-65.7C43.81 87.75 65.57 78.77 92.02 78h29.38L96.05 52.19c-5.75-5.73-8.63-13-8.63-21.79 0-8.8 2.88-16.06 8.63-21.797C101.8 2.868 109.1 0 117.9 0s16.1 2.868 21.9 8.603L213.1 78h88l74.5-69.397C381.7 2.868 389.2 0 398 0c8.8 0 16.1 2.868 21.9 8.603 5.7 5.737 8.6 12.997 8.6 21.797 0 8.79-2.9 16.06-8.6 21.79L394.6 78h29.3c26.4.77 48 9.75 64.7 26.1zm-38.8 69.7c-.4-9.6-3.7-17.4-10.7-23.5-5.2-6.1-14-9.4-22.7-9.8H96.05c-9.59.4-17.45 3.7-23.58 9.8-6.14 6.1-9.4 13.9-9.78 23.5v194.4c0 9.2 3.26 17 9.78 23.5s14.38 9.8 23.58 9.8H416.4c9.2 0 17-3.3 23.3-9.8 6.3-6.5 9.7-14.3 10.1-23.5V173.8zm-264.3 42.7c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2-6.2 6.3-14 9.5-23.6 9.5-9.6 0-17.5-3.2-23.6-9.5-6.1-6.3-9.4-14-9.8-23.2v-33.3c.4-9.1 3.8-16.9 10.1-23.2 6.3-6.3 13.2-9.6 23.3-10 9.2.4 17 3.7 23.3 10zm191.5 0c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2-6.1 6.3-14 9.5-23.6 9.5-9.6 0-17.4-3.2-23.6-9.5-7-6.3-9.4-14-9.7-23.2v-33.3c.3-9.1 3.7-16.9 10-23.2 6.3-6.3 14.1-9.6 23.3-10 9.2.4 17 3.7 23.3 10z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://eanyang7.com" target="_blank" rel="noopener" title="个人主页" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M112 48a48 48 0 1 1 96 0 48 48 0 1 1-96 0zm40 304v128c0 17.7-14.3 32-32 32s-32-14.3-32-32V256.9l-28.6 47.6c-9.1 15.1-28.8 20-43.9 10.9s-20-28.8-10.9-43.9l58.3-97c17.4-28.9 48.6-46.6 82.3-46.6h29.7c33.7 0 64.9 17.7 82.3 46.6l58.3 97c9.1 15.1 4.2 34.8-10.9 43.9s-34.8 4.2-43.9-10.9L232 256.9V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V352h-16z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.prune", "navigation.top", "toc.follow", "header.autohide", "navigation.footer", "search.suggest", "search.highlight", "search.share", "content.action.edit", "content.action.view", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.6c14ae12.min.js"></script>
      
    
  </body>
</html>